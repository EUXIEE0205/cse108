{% extends "base.html" %}
{% block title %}Home • MiniForum{% endblock %}

{% block content %}

  <div class="hero">
    <div>
      <div class="hero-title">Browse questions</div>
      <div class="hero-sub">Filter by topic, search keywords, and jump into answers.</div>
    </div>

    {% if me %}
      <a class="btn" href="{{ url_for('new_question_page') }}">+ New Question</a>
    {% else %}
      <a class="btn" href="{{ url_for('login_page') }}">Login to post</a>
    {% endif %}
  </div>

  <div class="card panel">
    <form method="get" action="{{ url_for('home') }}" class="filters2" style="align-items:flex-end; gap:12px;">
      <div class="field">
        <label>Topic</label>
        <select name="topic">
          <option value="" {% if not selected_topic %}selected{% endif %}>All</option>
          {% for t in topics %}
            <option value="{{ t }}" {% if t == selected_topic %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field">
        <label>Sort</label>
        <select name="sort">
          <option value="trending" {% if sort == "trending" %}selected{% endif %}>Trending</option>
          <option value="new" {% if sort == "new" %}selected{% endif %}>Newest</option>
          <option value="old" {% if sort == "old" %}selected{% endif %}>Oldest</option>
        </select>
      </div>

      <div class="field grow">
        <label>Search</label>
        <input name="q" value="{{ q }}" placeholder="Search title or body..." />
      </div>

      <button class="btn" type="submit">Search</button>
    </form>

    {% if me and selected_topic %}
      <div style="margin-top:8px;">
        {% if selected_topic in followed_topics %}
          <form method="post" action="{{ url_for('unfollow_topic') }}">
            <input type="hidden" name="topic" value="{{ selected_topic }}" />
            <button class="btn secondary" type="submit">Unfollow “{{ selected_topic }}”</button>
          </form>
        {% else %}
          <form method="post" action="{{ url_for('follow_topic') }}">
            <input type="hidden" name="topic" value="{{ selected_topic }}" />
            <button class="btn" type="submit">Follow “{{ selected_topic }}”</button>
          </form>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <div class="list2">
    {% for x in questions %}
      <a class="postrow" href="{{ url_for('question_detail', question_id=x.id) }}">
        <div class="postrow-accent"></div>

        <div class="postrow-main">
          <div class="postrow-meta">
            <span class="tag">{{ x.topic }}</span>
            <span class="dot">•</span>
            <span>{{ x.created_at|dt_pacific }}</span>
          </div>

          <div class="postrow-title">
            {{ x.title|highlight(q) }}
            {% if x.accepted_answer_id %}
              <span class="tag" style="margin-left:6px;">Solved</span>
            {% endif %}
          </div>

          <div class="postrow-sub">
            by <span class="user">{% if x.is_anonymous %}Anonymous{% else %}{{ x.author.username }}{% endif %}</span>
            <span class="dot">•</span>
            <span class="count">{{ answer_counts.get(x.id, 0) }} answers</span>
          </div>

          <div class="postrow-preview">{{ x.body|highlight(q) }}</div>
        </div>
      </a>
      {% if me and (me.id == x.author_id or me_is_admin) %}
        <div style="margin:6px 12px 18px 12px;">
          <a class="btn small" href="{{ url_for('edit_question_page', question_id=x.id) }}">Edit</a>
        </div>
      {% endif %}
    {% endfor %}

    {% if questions|length == 0 %}
      <div class="empty">
        <div class="empty-title">No questions found</div>
        <div class="muted">Try a different topic or search term.</div>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h3>Top Users</h3>
      <a href="{{ url_for('leaderboard_page') }}">View all</a>
    </div>
    {% if leaderboard_top and leaderboard_top|length > 0 %}
      <ol style="margin-left:16px;">
        {% for r in leaderboard_top %}
          <li style="margin:6px 0;">
            <span class="user">{{ r.username }}</span>
            <span class="muted">• {{ r.points }} pts</span>
          </li>
        {% endfor %}
      </ol>
    {% else %}
      <div class="muted">No users yet.</div>
    {% endif %}
  </div>

{% endblock %}
