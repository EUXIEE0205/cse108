{% extends "base.html" %}
{% block title %}{{ question.title }} • MiniForum{% endblock %}

{% block content %}
  <div class="card">
    <div class="muted">{{ question.topic }} • {{ question.created_at|dt_pacific }}</div>
    <h2>{{ question.title }}</h2>
    <div class="muted">by {% if question.is_anonymous %}Anonymous{% else %}{{ question.author.username }}{% endif %}</div>
    <div class="markdown">{{ question.body|md }}</div>
    {% if me %}
      <form method="post" action="{{ url_for('report_question', question_id=question.id) }}" style="margin-top:8px; display:flex; gap:8px;">
        <input name="reason" placeholder="Reason" />
        <button class="btn secondary" type="submit">Report</button>
      </form>
    {% endif %}
    {% if me and me.id == question.author_id %}
      <div style="margin-top:8px; display:flex; gap:8px;">
        <a class="btn" href="{{ url_for('edit_question_page', question_id=question.id) }}">Edit Question</a>
        <form method="post" action="{{ url_for('delete_question', question_id=question.id) }}" class="confirm-delete">
          <button class="btn secondary" type="submit">Delete Question</button>
        </form>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <h3>Answers</h3>

    {% if answers|length == 0 %}
      <div class="muted">No answers yet.</div>
    {% endif %}

    {% for a in answers %}
      <div class="answer">
        <div class="answer-vote">
          <!-- ONE FORM: buttons submit their own value reliably -->
          <form method="post" action="{{ url_for('vote', answer_id=a.id) }}" class="vote-form">
            <button
              class="btn small {% if my_votes.get(a.id) == 1 %}active{% endif %}"
              name="value"
              value="1"
              type="submit"
            >▲</button>

            <div class="score">{{ a.score }}</div>

            <button
              class="btn small {% if my_votes.get(a.id) == -1 %}active{% endif %}"
              name="value"
              value="-1"
              type="submit"
            >▼</button>
          </form>
        </div>

        <div class="answer-body">
          <div class="muted">
            by {{ a.author.username }} • {{ a.created_at|dt_pacific }}
            {% if question.accepted_answer_id == a.id %}
              <span class="tag" style="margin-left:6px;">Accepted ✅</span>
            {% endif %}
          </div>
          <div class="markdown">{{ a.body|md }}</div>
          {% if me %}
            <form method="post" action="{{ url_for('report_answer', answer_id=a.id) }}" style="margin-top:6px; display:flex; gap:8px;">
              <input name="reason" placeholder="Reason" />
              <button class="btn small secondary" type="submit">Report</button>
            </form>
          {% endif %}
          {% if me and me.id == a.author_id %}
            <div style="margin-top:6px; display:flex; gap:8px;">
              <a class="btn small" href="{{ url_for('edit_answer_page', answer_id=a.id) }}">Edit Answer</a>
              <form method="post" action="{{ url_for('delete_answer', answer_id=a.id) }}" class="confirm-delete">
                <button class="btn small secondary" type="submit">Delete Answer</button>
              </form>
            </div>
          {% endif %}

          {% if me and me.id == question.author_id %}
            {% if question.accepted_answer_id != a.id %}
              <form method="post" action="{{ url_for('accept_answer', question_id=question.id, answer_id=a.id) }}" style="margin-top:6px;">
                <button class="btn small" type="submit">Accept ✅</button>
              </form>
            {% endif %}
          {% endif %}

          <!-- COMMENTS -->
          <div class="comments">
            <div class="muted" style="margin-top:10px;">Comments</div>

            {% set clist = comments_by_answer.get(a.id, []) %}
            {% if clist|length == 0 %}
              <div class="muted smalltext">No comments yet.</div>
            {% else %}
              {% for c in clist %}
                <div class="comment">
                  <div class="muted smalltext">
                    {{ c.author.username }} • {{ c.created_at|dt_pacific }}
                  </div>
                  <div class="smalltext">{{ c.body }}</div>
                </div>
              {% endfor %}
            {% endif %}

            {% if me %}
              <form class="comment-form" method="post" action="{{ url_for('add_comment', answer_id=a.id) }}">
                <input name="body" placeholder="Reply to this answer..." />
                <button class="btn secondary" type="submit">Reply</button>
              </form>
            {% else %}
              <div class="muted smalltext">
                <a href="{{ url_for('login_page') }}">Login</a> to comment.
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  {% if similar_questions and similar_questions|length > 0 %}
    <div class="card">
      <h3>Similar questions</h3>
      <ul style="margin-left:16px;">
        {% for s in similar_questions %}
          <li style="margin:6px 0;">
            <a href="{{ url_for('question_detail', question_id=s.id) }}">{{ s.title }}</a>
            <span class="muted">• {{ s.topic }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="card">
    <h3>Add an answer</h3>
    {% if not me %}
      <div class="muted">You must <a href="{{ url_for('login_page') }}">login</a> to answer.</div>
    {% else %}
      <form method="post" action="{{ url_for('add_answer', question_id=question.id) }}">
        <textarea name="body" rows="5"></textarea>
        <button class="btn" type="submit">Post Answer</button>
      </form>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  <script>
    (function() {
      function attachConfirm(selector, message) {
        var forms = document.querySelectorAll(selector);
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(e) {
            if (!confirm(message)) {
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
          });
        }
      }
      attachConfirm('form.confirm-delete', '确认删除？此操作不可恢复。');
    })();
  </script>
{% endblock %}
